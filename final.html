<!DOCTYPE html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>d3-simple-slider</title>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-simple-slider"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body, button, select, text {
            font-family: 'Lato', sans-serif;
        }

        select {
            font-size: 15px;
            text-align: center;
        }

        .current-time-container, .slider, .button-container, .annotations-container, .player-selection {
            display: flex;
            justify-content: center;
        }

        .stat-selector-container {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .stat-selector-label {
            margin-right: 1vw; 
        }

        #stat-selector {
            height: 30px;
        }

        .player-cards {
            display: flex;
            flex-direction: row;
        }

        .player-selection-img {
            height: 300px;
        }

        .player-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 14vw;
            border-right: 1px solid gray;
        }

        .player-info {
            text-align: center;
        }

        .null-container {
            width: 9vw;
        }

        .player-name, .player-selector {
            margin-top: 0;
            margin-bottom: 0;
        }

    </style>

</head>

<body>
    <div class="slider-outer-container">
        <div class="slider-inner-container">
            <div class="current-time-container">
                <p id="current-time"></p>
            </div>
            <div class="slider">
                <div id="slider-time"></div>
            </div>
        </div>
    </div>

    <div class="button-container">
        <button id="continue-button" disabled> Continue Animation </button>
    </div>
    
    <div class="annotations-container">
        <p class="current-annotation"> Here is some data for each year since 1996. </p>
    </div>

    <h2 style="text-align:center;"> Player Comparison </h2>
    <div class="stat-selector-container">
        <p class="stat-selector-label">Current Statistic: </p>
        <select id="stat-selector" class="dropdown"></select>
    </div>
    
    <div class="player-selection">
        <div class="player-cards">
            <div class="null-container player-null">
                <div class="null-image-container">
                    <img class="player-selection-img" src="player-images/empty.png">
                </div>
                <div class="player-name-container">
                    <p class="player-name"> &nbsp; </p>
                </div>
                <div class="null-info">
                    <p class="years-played"> <strong> Seasons Played </strong> </p>
                    <p class="player-stat"> <strong> Career Average </strong> </p>
                    <p class="league-average-stat"> <strong> League Average </strong> </p>
                    <p class="adjusted-stat"> <strong> Relative to Average </strong> </p>

                </div>
            </div>

            <div class="player-container player-0">

            </div>
            
            <div class="player-container player-1">
                <div class="player-image-container"></div>
                <div class="player-name-container">
                    <select id="player-selector-1" class="player-selector dropdown"></select>
                </div>
                <div class="player-stats-container"></div>

            </div>
            
            <div class="player-container player-2">
                <div class="player-image-container"></div>
                <div class="player-name-container">
                    <select id="player-selector-2" class="player-selector dropdown"></select>
                </div>
                <div class="player-stats-container"></div>
            </div>
            
            <div class="player-container player-3">
                <div class="player-image-container"></div>
                <div class="player-name-container">
                    <select id="player-selector-3" class="player-selector dropdown"></select>
                </div>
                <div class="player-stats-container"></div>
            </div>
            
            <div class="player-container player-4">
                <div class="player-image-container"></div>
                <div class="player-name-container">
                    <select id="player-selector-4" class="player-selector dropdown"></select>
                </div>
                <div class="player-stats-container"></div>
            </div>
        </div>
    </div>
</body>


<script>
    // Global time variable to use for all visualizations.
    let globalTime;

    // Time Slider (starter code from: https://bl.ocks.org/johnwalley/e1d256b81e51da68f7feb632a53c3518).
    var dataTime = d3.range(0, 25).map(function (d) {
        return 1996 + d;
    });

    var sliderTime = d3
        .sliderBottom()
        .min(d3.min(dataTime))
        .max(d3.max(dataTime))
        .step(1)
        .width(950)
        .tickFormat(d3.format("d"))
        .tickValues(dataTime)
        .default(1996)
        .fill('#2196f3')
        .on('onchange', val => {
            globalTime = val;
            d3.select('p#current-time').text(val);
        });

    var gTime = d3
        .select('div#slider-time')
        .append('svg')
        .attr('width', 1000)
        .attr('height', 100)
        .attr('display', 'flex')
        .attr('justify-content', 'center')
        .append('g')
        .attr('transform', 'translate(30,30)');

    gTime.call(sliderTime);

    // Create an animation for the slider.
    var firstSliderAnimation = setInterval(() => {
        let currentTime = sliderTime.value()

        if (currentTime == 2009) {
            d3.select('#continue-button').attr('disabled', null);
            clearInterval(firstSliderAnimation)
            d3.select('.current-annotation').html('In 2009, Steph Curry changed everything.')
        }
        else {
            sliderTime.value(currentTime + 1);
            gTime
                .transition()
                .duration(200)
                .call(sliderTime);
        }
    }, 500);

    d3.select('p#current-time').text(sliderTime.value());
    d3.select('#continue-button').on("click", (event, d) => {
        d3.select('#continue-button').attr('disabled', true);
        var secondSliderAnimation = setInterval(() => {
            let currentTime = sliderTime.value()

            if (currentTime == d3.max(dataTime)) {
                clearInterval(secondSliderAnimation)
            }
            else {
                sliderTime.value(currentTime + 1);
                gTime
                    .transition()
                    .duration(200)
                    .call(sliderTime);
            }
        }, 500);
    })

    // Player Selection Visualization
    const result = d3.csv('player-selection.csv')
            .then((data) => processStats(data));
    
    let globalPlayerData = {};
    let selectedPlayers = {};
    let availablePlayers;

    processStats = (data) => {
        // Create a global player data dictionary indexed by player name.
        data.forEach(player => {
            const key = player['Name']
            const stats = {...player}
            delete stats['Name']
            globalPlayerData[key] = stats
        });

        // Render the initial 5 players (Steph and 4 others).
        for (let i=0; i<5; i++) {
            renderPlayerCard(i, data[i])
        }

        // Create a list of available players to select from for dropdowns.
        availablePlayers = data.slice(1, data.length).map((player) => {
            return player['Name']
        });

        initializeDropdowns();
    }

    renderPlayerCard = (playerIndex, playerData) => {
        const playerCardSelector = '.player-' + playerIndex.toString()
        const leagueKey = 'League ' + statVar

        let playerStat = playerData[statVar]
        let leagueStat = playerData[leagueKey]
        const adjusted = Math.round(100 * (playerData[statVar] / playerData[leagueKey])) / 100

        const stephStat = globalPlayerData['Stephen Curry'][statVar]
        const stephLeague = globalPlayerData['Stephen Curry'][leagueKey]
        const stephAdjusted = Math.round(100 * (stephStat / stephLeague)) / 100

        const statBool = playerStat >= stephStat
        const adjustedBool = adjusted >= stephAdjusted

        if (statVar == '3P%') {
            playerStat = (Math.round(1000 * playerStat) / 10).toString() + '%'
            leagueStat = (Math.round(1000 * leagueStat) / 10).toString() + '%'
        }
        
        if (playerIndex == 0) {
            d3.select(playerCardSelector).html(
                `
            <div class="player-image-container">
                <img class="player-selection-img" src="player-images/steph.png">
            </div>
            <div class="player-name-container">
                <p class="player-name"> Stephen Curry </p>
            </div>
            <div class="${"player-" + playerIndex.toString() + "-info"} player-info">
                <p class="years-played"> ${playerData['Start Year'] + "-" + playerData['End Year']} </p>
                <p class="player-stat"> ${playerStat} </p>
                <p class="league-average-stat"> ${leagueStat} </p>
                <p class="adjusted-stat"> ${adjusted}x </p>
            </div> 
            `
            )
        }
        else {
            const imageURL = "player-images/" + playerData["Image URL"]
            console.log(imageURL)
            d3.select(playerCardSelector + " .player-image-container").html(
                `
            <img class="player-selection-img" src=${imageURL}>
            `
            )
            d3.select(playerCardSelector + " .player-stats-container").html(
                `
            <div class="${"player-" + playerIndex.toString() + "-info"} player-info">
                <p class="years-played"> ${playerData['Start Year'] + "-" + playerData['End Year']} </p>
                <p class="player-stat" style=${statBool ? "color:green" : "color:red"}> ${playerStat} </p>
                <p class="league-average-stat"> ${leagueStat} </p>
                <p class="adjusted-stat" style=${adjustedBool ? "color:green" : "color:red"}> ${adjusted}x</p>
            </div> 
            `
            )
        }
    }

    renderAllCards = () => {
        for (let i = 0; i < 5; i++) {
            if (i==0) {
                renderPlayerCard(0, globalPlayerData["Stephen Curry"])
            }
            else {
                const dropdownId = "#player-selector-" + i.toString();
                const currentPlayer = d3.select(dropdownId).property("value");
                renderPlayerCard(i, globalPlayerData[currentPlayer])
            }
        }
    }

    let statVar;
    let statOptions = ['3P', '3PA', '3P%']
    initializeDropdowns = () => {
        d3.select("#stat-selector")
            .selectAll('myOptions')
            .data(statOptions)
            .enter()
            .append('option')
            .text(function (d) { return d; }) // text showed in the menu
            .attr("value", function (d) { return d; }) // corresponding value returned by the button

        for (let i=1; i<5; i++) {
            // Create dropdown with players as options.
            const dropdownId = "#player-selector-" + i.toString();
            d3.select(dropdownId)
                .selectAll('myOptions')
                .data(availablePlayers)
                .enter()
                .append('option')
                .text(function (d) { return d; }) // text showed in the menu
                .attr("value", function (d) { return d; }) // corresponding value returned by the buttons
            
            // Fill initial player values.
            d3.select(dropdownId).property('value', Object.keys(globalPlayerData)[i])

            // Add event listeners for changes.
            d3.select(dropdownId).on("change", function (event, d) {
                // recover the option that has been chosen
                const selectedPlayer = d3.select(this).property("value")
                const selectorIndex = this.id.slice(-1)
                renderPlayerCard(selectorIndex, globalPlayerData[selectedPlayer])

            })


        }
    }
    statVar = "3P"


    d3.select("#stat-selector").on("change", function (event, d) {
        // recover the option that has been chosen
        const selectedOption = d3.select(this).property("value")
        statVar = selectedOption;
        renderAllCards();
        // drawBar(centroid.features);
    })

</script>